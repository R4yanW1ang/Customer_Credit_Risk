-- DWS sql 
-- ******************************************************************** --
-- author: hw_wangzirui
-- 主题域：光伏销售
-- 功能：统计光伏客户的客户概要、综合评价、授信建议
-- 入参: 无
-- 出参: 无
-- 异常处理: 回滚
-- 调度周期：月
-- 目标表：***
-- 来源表：***
-- 更新方式：每月插入新数据
-- create time: 2022/07/27 16:57:17 GMT+08:00
-- ******************************************************************** --
DELETE FROM T1
WHERE YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM'); --删除上月数据，防止多次执行后插入重复数据


INSERT INTO T1
(
CUSTOMER_NAME,
CUSTOMER_NUMBER,
YEAR_MONTH,
ACTUAL_CAPITAL,
COMPANY_ORG_TYPE,
ESTABLISH_DATE,
STAFF_NUMBER_RANGE,
REG_STATUS,
LEGAL_PERSON_NAME,
CUSTOMER_SCORE,
CUSTOMER_RATE,
SUGGESTED_CREDIT_LIMIT,
SUGGESTED_CREDIT_DAYS,
CUSTOMER_PERFORMANCE,
ENTERPRISE_SOLVENCY,
COOPERATION_SCALE,
BUSINESS_PERFORMANCE,
ENTERPRISE_QUALITY,
AGREEMENT_PERFORMANCE,
CURRENCY_CODE,
CREDIT_LIMIT,
CREDIT_DAYS,
CREDIT_USAGE,
PAY_MODE,
DWS_UPDATE_DATE
)

WITH CPS AS
(
SELECT CPS.CUSTOMER_NAME
     , CPS.YEARLY_AVG_SALE_AMT
     , CCS.CUSTOMER_RATE
     , CCS.CUSTOMER_SCORE
     , CASE WHEN CCS.CUSTOMER_RATE = '问题客户' THEN 0
       ELSE 
            CASE WHEN CCS.CUSTOMER_SCORE >= 85 THEN 1.5
            WHEN CCS.CUSTOMER_SCORE >= 60 THEN 1.3
            ELSE 0.9 END
       END CREDIT_LIMIT_COEFFICIENT --将客户评分转化为客户评级
     , CASE WHEN CCS.CUSTOMER_RATE = '问题客户' THEN 0 ELSE 1 END CREDIT_DAYS_COEFFICIENT
     , CASE WHEN CCS.CUSTOMER_RATE = '问题客户' THEN 0
       ELSE 
            CASE WHEN CCS.CUSTOMER_SCORE >= 85 THEN 1.2
            WHEN CCS.CUSTOMER_SCORE >= 60 THEN 1.05
            ELSE 0.95 END
       END CREDIT_LIMIT_COEFFICIENT_2 --将客户评分转化为客户评级
  FROM T2 CPS
  LEFT JOIN T3 CCS
    ON CPS.CUSTOMER_NAME = CCS.CUSTOMER_NAME
 WHERE CPS.YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')
   AND CCS.YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')
)

SELECT CMB.CUSTOMER_NAME
     , CMB.CUSTOMER_NUMBER
     , TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM') YEAR_MONTH
     , TBI.ACTUAL_CAPITAL
     , TBI.COMPANY_ORG_TYPE
     , TBI.ESTABLISH_DATE
     , TBI.STAFF_NUMBER_RANGE
     , TBI.REG_STATUS
     , TBI.LEGAL_PERSON_NAME
     , CCS.CUSTOMER_SCORE
     , CCS.CUSTOMER_RATE
     , COALESCE(
       CASE WHEN SCA.CREDIT_DAYS = 0 THEN 0 
            WHEN SCA.CREDIT_LIMIT = 0 THEN 0
                     ELSE ROUND(CPS.CREDIT_LIMIT_COEFFICIENT * CPS.YEARLY_AVG_SALE_AMT * SCA.CREDIT_DAYS / 30 , 0)
                     END, 0) SUGGESTED_CREDIT_LIMIT --推荐信用额度=信用评级系数*近一年月均销售额*信用天数/30
                        --  (CASE WHEN ABS((ROUND(CPS.CREDIT_LIMIT_COEFFICIENT * CPS.YEARLY_AVG_SALE_AMT * SCA.CREDIT_DAYS / 30 , 0) - SCA.CREDIT_LIMIT) / SCA.CREDIT_LIMIT) <= 0.2 THEN ROUND(CPS.CREDIT_LIMIT_COEFFICIENT * CPS.YEARLY_AVG_SALE_AMT * SCA.CREDIT_DAYS / 30 , 0)
                        --   ELSE ROUND(SCA.CREDIT_LIMIT * CREDIT_LIMIT_COEFFICIENT_2) END)
                    --  END, 0) SUGGESTED_CREDIT_LIMIT --推荐信用额度=信用评级系数*近一年月均销售额*信用天数/30
    --  , COALESCE(CASE WHEN SCA.CREDIT_DAYS = 0 THEN 0 
    --             ELSE ROUND(CPS.CREDIT_LIMIT_COEFFICIENT * CPS.YEARLY_AVG_SALE_AMT * SCA.CREDIT_DAYS / 30 , 0) END, 0) SUGGESTED_CREDIT_LIMIT --推荐信用额度=信用评级系数*近一年月均销售额*信用天数/30
     , COALESCE(CPS.CREDIT_DAYS_COEFFICIENT * SCA.CREDIT_DAYS, 0) SUGGESTED_CREDIT_DAYS --推荐信用天数=信用评级系数*现有信用天数
     , CCS.CUSTOMER_PERFORMANCE
     , CCS.ENTERPRISE_SOLVENCY
     , CCS.COOPERATION_SCALE
     , CCS.BUSINESS_PERFORMANCE
     , CCS.ENTERPRISE_QUALITY
     , CCS.AGREEMENT_PERFORMANCE
     , COALESCE(SCA.CURRENCY_CODE, 'CNY') CURRENCY_CODE
     , COALESCE(SCA.CREDIT_LIMIT ,0) CREDIT_LIMIT
     , COALESCE(SCA.CREDIT_DAYS, 0) CREDIT_DAYS
     , COALESCE(SCA.CREDIT_USAGE, 0) CREDIT_USAGE
     , CMB.PAY_MODE
     , CURRENT_TIMESTAMP DWS_UPDATE_DATE
  FROM (SELECT * FROM T2 WHERE YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')) CMB
  LEFT JOIN T3 CCS
    ON CMB.CUSTOMER_NAME = CCS.CUSTOMER_NAME
   AND CCS.YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')
  LEFT JOIN (SELECT * FROM T3 WHERE YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')) SCA
    ON CMB.CUSTOMER_NAME = SCA.CUSTOMER_NAME
  LEFT JOIN T4 TBI
    ON CMB.CUSTOMER_NAME = TBI.CUSTOMER_NAME
   AND TBI.YEAR_MONTH = TO_CHAR(CURRENT_TIMESTAMP, 'YYYY-MM')
  LEFT JOIN CPS
    ON CMB.CUSTOMER_NAME = CPS.CUSTOMER_NAME;